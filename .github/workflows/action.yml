name: Python CI with uv and linting

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]


env:
  PYTHON_VERSION: '3.11'



jobs:
  build:
    name: 🔧 Build Environment
    runs-on: ubuntu-latest

    outputs:
      python-version: ${{ steps.setup_python.outputs.python-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup_python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -Ls https://astral.sh/uv/install.sh | bash
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install flake8
        run: |
          uv pip install flake8

  lint:
    name: 🧹 Lint Code
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: *python-version

      - name: Install uv
        run: |
          curl -Ls https://astral.sh/uv/install.sh | bash
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install flake8
        run: |
          uv pip install flake8

      - name: Run flake8
        run: |
          echo "Running flake8..."
          flake8 . || echo "⚠️ Lint warnings found"
        continue-on-error: true

  test:
    name: 🧪 Run Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: *python-version

      - name: Install uv
        run: |
          curl -Ls https://astral.sh/uv/install.sh | bash
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies and pytest
        run: |
          uv sync 

      - name: Run tests
        run: |
          echo "Running tests..."
          ./run_tests.sh
