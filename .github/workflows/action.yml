name: Python CI with uv and linting

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

env:
  PYTHON_VERSION: "3.12"
  UV_BIN_DIR: "$HOME/.cargo/bin"

jobs:
  build:
    name: ðŸ”§ Build Environment
    runs-on: ubuntu-latest

    outputs:
      python-version: ${{ steps.setup_python.outputs.python-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup_python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Ensure uv bin dir exists
        run: mkdir -p ${{ env.UV_BIN_DIR }}

      - name: Cache uv binary
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_BIN_DIR }}
          key: uv-bin-${{ runner.os }}

      - name: Install uv (if not cached)
        run: |
          if ! command -v uv &> /dev/null; then
            curl -Ls https://astral.sh/uv/install.sh | bash
          fi

      - name: Add uv to PATH
        run: echo "$UV_BIN_DIR" >> $GITHUB_PATH

  lint:
    name: ðŸ§¹ Lint Code
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.build.outputs.python-version }}

      - name: Restore uv binary
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_BIN_DIR }}
          key: uv-bin-${{ runner.os }}

      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv pip install --system flake8 pytest
      - name: Run flake8
        run: flake8 .

  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.build.outputs.python-version }}

      - name: Restore uv binary
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_BIN_DIR }}
          key: uv-bin-${{ runner.os }}

      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run tests
        run: ./run_tests.sh
